<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Paths - Interactive Audio Stories</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }

        .screen.hidden {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .header {
            padding: 40px 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4ecdc4;
        }

        .content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            max-width: 1200px;
            width: 100%;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.15);
            border-color: #4ecdc4;
            box-shadow: 0 10px 30px rgba(76, 205, 196, 0.3);
        }

        .card h3 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .card p {
            opacity: 0.8;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .card .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .story-card {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #4ecdc4;
            text-align: left;
        }

        .story-card h3 {
            color: #4ecdc4;
        }

        .story-card .creator {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .episode-card {
            background: rgba(255, 255, 255, 0.08);
            border-left: 4px solid #ff6b6b;
        }

        .episode-card h3 {
            color: #ff6b6b;
        }

        .episode-card .description {
            opacity: 0.8;
            margin-top: 10px;
            font-size: 0.95rem;
        }

        /* Player Screen Styles */
        .player-screen {
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .background-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.4;
            z-index: 1;
        }

        .player-content {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            gap: 20px;
        }

        .story-map-panel {
            width: 300px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #333;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            transition: transform 0.3s ease;
        }

        .story-map-panel.collapsed {
            transform: translateX(320px);
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .map-title {
            color: #4ecdc4;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .map-toggle {
            background: none;
            border: 1px solid #666;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .map-toggle:hover {
            border-color: #4ecdc4;
        }

        .story-node {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-size: 0.9rem;
        }

        .story-node.current {
            background: rgba(76, 205, 196, 0.2);
            border-left-color: #4ecdc4;
            color: #4ecdc4;
        }

        .story-node.completed {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #888;
            color: #ccc;
        }

        .story-node.available {
            background: rgba(255, 107, 107, 0.1);
            border-left-color: #ff6b6b;
            color: #ff6b6b;
        }

        .story-node.locked {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #444;
            color: #666;
            cursor: not-allowed;
        }

        .story-node:hover:not(.locked) {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .node-indent-1 { margin-left: 15px; }
        .node-indent-2 { margin-left: 30px; }

        .path-connector {
            margin: 5px 0;
            padding-left: 10px;
            color: #666;
            font-size: 0.8rem;
        }

        .radio-container {
            display: flex;
            align-items: center;
            gap: 40px;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #333;
            max-width: 90%;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .radio-image {
            width: 300px;
            height: 300px;
            background-image: url('audio/mystery/murder-show/murder-show.jpg');
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            border: 3px solid #666;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 400px;
        }

        .episode-title {
            font-size: 1.8rem;
            color: #4ecdc4;
            text-align: center;
            margin-bottom: 20px;
        }

        .story-text {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            color: white;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4ecdc4;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .choice-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .choice-btn.show {
            opacity: 1;
            transform: translateY(0);
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .radio-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .radio-image {
                width: 200px;
                height: 200px;
            }
            
            .controls-panel {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: Homepage - Genre Selection -->
    <div class="screen" id="homeScreen">
        <div class="header">
            <h1>Pick Paths</h1>
            <p>Choose your own adventure in immersive audio experiences</p>
        </div>
        <div class="content">
            <div class="grid">
                <div class="card" onclick="showGenre('mystery')">
                    <span class="icon">🔍</span>
                    <h3>Mystery</h3>
                    <p>Solve crimes, uncover secrets, and navigate deadly conspiracies where every choice matters.</p>
                </div>
                <div class="card" onclick="showGenre('horror')">
                    <span class="icon">👻</span>
                    <h3>Horror</h3>
                    <p>Face your fears in spine-chilling tales where survival depends on your decisions.</p>
                </div>
                <div class="card" onclick="showGenre('sci-fi')">
                    <span class="icon">🚀</span>
                    <h3>Sci-Fi</h3>
                    <p>Explore distant worlds and face impossible choices in futuristic adventures.</p>
                </div>
                <div class="card" onclick="showGenre('romance')">
                    <span class="icon">💕</span>
                    <h3>Romance</h3>
                    <p>Navigate matters of the heart where your choices shape love stories.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: Genre Stories -->
    <div class="screen hidden" id="genreScreen">
        <div class="header">
            <button class="back-btn" onclick="goToHome()">← Back</button>
            <h1 id="genreTitle">Mystery Stories</h1>
            <p>Choose your story adventure</p>
        </div>
        <div class="content">
            <div class="grid" id="storiesGrid">
                <!-- Stories will be populated here -->
            </div>
        </div>
    </div>

    <!-- SCREEN 3: Story Episodes -->
    <div class="screen hidden" id="storyScreen">
        <div class="header">
            <button class="back-btn" onclick="goToGenre()">← Back</button>            
            <h1 id="storyTitle">The Murder Show</h1>
            <p id="storyCreator">by Miles Productions</p>
        </div>
        <div class="content">
            <div class="grid" id="episodesGrid">
                <!-- Episodes will be populated here -->
            </div>
        </div>
    </div>

    <!-- SCREEN 4: Player -->
    <div class="screen hidden player-screen" id="playerScreen">
        <video class="background-video" autoplay muted loop>
            <source src="audio/mystery/murder-show/murder-show.mp4" type="video/mp4">
        </video>
        <button class="back-btn" onclick="goToStory()">← Back</button>
        <div class="player-content">
            <div class="radio-container">
                <div class="radio-image"></div>
                <div class="controls-panel">
                    <div class="episode-title" id="episodeTitle">Episode 1: Death at Blackwood Manor</div>
                    <div class="story-text" id="storyText">
                        Click play to begin your interactive adventure...
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>
                    <div class="control-buttons">
                        <button class="control-btn" id="playPauseBtn" onclick="togglePlay()">▶️</button>
                        <button class="control-btn" onclick="rewind()">⏪</button>
                        <button class="control-btn" onclick="restart()">🔄</button>
                    </div>
                    <div class="choices-container" id="choicesContainer">
                        <!-- Choices appear here -->
                    </div>
                </div>
            </div>
            
            <div class="story-map-panel" id="storyMapPanel">
                <div class="map-header">
                    <div class="map-title">Story Path</div>
                    <button class="map-toggle" onclick="toggleStoryMap()">Hide</button>
                </div>
                <div id="storyMapContent">
                    <!-- Story map will be built here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGenre = '';
        let currentStory = '';
        let currentEpisode = '';
        let currentAudio = null;
        let isPlaying = false;
        let currentSegmentId = '';
        let storyProgress = {
            completed: [],
            currentPath: []
        };

        // Story structure with tree relationships
        const storyTree = {
            "1A_opening": {
                title: "The Dinner Party Begins",
                level: 0,
                children: ["1B_cellar", "1C_upstairs"]
            },
            "1B_cellar": {
                title: "Down in the Cellar", 
                level: 1,
                parent: "1A_opening",
                children: ["2A_confront", "2B_escape"]
            },
            "1C_upstairs": {
                title: "The Upper Floors",
                level: 1, 
                parent: "1A_opening",
                children: ["2C_announcement", "2D_search_room"]
            },
            "2A_confront": {
                title: "The Confrontation",
                level: 2,
                parent: "1B_cellar",
                children: ["3A_finale", "3B_finale"]
            },
            "2B_escape": {
                title: "The Escape Attempt", 
                level: 2,
                parent: "1B_cellar",
                children: ["3C_finale", "3D_finale"]
            },
            "2C_announcement": {
                title: "Richard's Revelation",
                level: 2,
                parent: "1C_upstairs", 
                children: ["3E_finale", "3F_finale"]
            },
            "2D_search_room": {
                title: "The Hidden Evidence",
                level: 2,
                parent: "1C_upstairs",
                children: ["3G_finale", "3H_finale"]
            }
        };

        // Story structure with actual audio files and choice timings
        const storySegments = {
            "1A_opening": {
                title: "The Dinner Party Begins",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 1A_OPENING.mp3",
                choices: [
                    { text: "Investigate the mysterious cellar", next: "1B_cellar" },
                    { text: "Search the upstairs rooms", next: "1C_upstairs" }
                ],
                choiceTime: 85 // Show choices at 85% through the audio
            },
            "1B_cellar": {
                title: "Down in the Cellar",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 1B_CELLAR.mp3",
                choices: [
                    { text: "Confront the conspirators", next: "2A_confront" },
                    { text: "Try to escape undetected", next: "2B_escape" }
                ],
                choiceTime: 85
            },
            "1C_upstairs": {
                title: "The Upper Floors", 
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 1C_UPSTAIRS.mp3",
                choices: [
                    { text: "Follow them to the announcement", next: "2C_announcement" },
                    { text: "Search the room for evidence", next: "2D_search_room" }
                ],
                choiceTime: 85
            },
            "2A_confront": {
                title: "The Confrontation",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 2A_CONFRONT.mp3",
                choices: [
                    { text: "Warn Richard of the danger", next: "3A_finale" },
                    { text: "Let events unfold", next: "3B_finale" }
                ],
                choiceTime: 85
            },
            "2B_escape": {
                title: "The Escape Attempt",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 2B_ESCAPE.mp3",
                choices: [
                    { text: "Run for help", next: "3C_finale" },
                    { text: "Protect Victoria", next: "3D_finale" }
                ],
                choiceTime: 85
            },
            "2C_announcement": {
                title: "Richard's Revelation",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 2C_ANNOUNCEMENT.mp3",
                choices: [
                    { text: "Search for Richard", next: "3E_finale" },
                    { text: "Try to escape the manor", next: "3F_finale" }
                ],
                choiceTime: 85
            },
            "2D_search_room": {
                title: "The Hidden Evidence",
                audio: "audio/mystery/murder-show/episode-1/THE MURDER SHOW - EPISODE 01 - 2D_SEARCH_ROOM.mp3",
                choices: [
                    { text: "Trust Margaret and help her escape", next: "3G_finale" },
                    { text: "Face Charles Morrison alone", next: "3H_finale" }
                ],
                choiceTime: 85
            }
        };

        // Sample data structure
        const genreData = {
            mystery: {
                title: "Mystery Stories",
                stories: {
                    "murder-show": {
                        title: "The Murder Show",
                        creator: "Miles Productions",
                        description: "Interactive murder mysteries in classic radio style",
                        episodes: {
                            "episode-1": {
                                title: "Death at Blackwood Manor",
                                description: "A dinner party turns deadly when secrets are revealed"
                            },
                            "episode-2": {
                                title: "The Lighthouse Mystery", 
                                description: "Strange disappearances on a remote island"
                            }
                        }
                    },
                    "sherlock-chronicles": {
                        title: "The Sherlock Chronicles",
                        creator: "Classic Tales",
                        description: "Help Holmes solve his greatest mysteries",
                        episodes: {
                            "episode-1": {
                                title: "The Missing Heir",
                                description: "A wealthy family's dark secret"
                            }
                        }
                    }
                }
            },
            horror: {
                title: "Horror Stories",
                stories: {
                    "midnight-tales": {
                        title: "Midnight Tales",
                        creator: "Dark Audio",
                        description: "Terrifying choices in the dead of night",
                        episodes: {
                            "episode-1": {
                                title: "The Haunted House",
                                description: "Will you survive the night?"
                            }
                        }
                    }
                }
            },
            "sci-fi": {
                title: "Science Fiction",
                stories: {
                    "space-mysteries": {
                        title: "Space Mysteries",
                        creator: "Cosmic Stories",
                        description: "Adventures across the galaxy",
                        episodes: {
                            "episode-1": {
                                title: "The Lost Ship",
                                description: "What happened to the crew?"
                            }
                        }
                    }
                }
            },
            romance: {
                title: "Romance Stories",
                stories: {
                    "love-letters": {
                        title: "Love Letters",
                        creator: "Heartstring Audio",
                        description: "Find your perfect ending",
                        episodes: {
                            "episode-1": {
                                title: "The Coffee Shop",
                                description: "Where love begins"
                            }
                        }
                    }
                }
            }
        };

        // FIXED NAVIGATION FUNCTIONS
        function showScreen(hideId, showId) {
            // Hide current screen
            document.getElementById(hideId).classList.add('hidden');
            // Show new screen after transition
            setTimeout(() => {
                document.getElementById(showId).classList.remove('hidden');
            }, 100);
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                isPlaying = false;
                document.getElementById('playPauseBtn').textContent = '▶️';
            }
        }

        function resetPlayerState() {
            stopAudio();
            document.getElementById('choicesContainer').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('currentTime').textContent = '0:00';
            document.getElementById('totalTime').textContent = '0:00';
            document.getElementById('storyText').textContent = 'Click play to begin your interactive adventure...';
        }

        // Navigation functions
        function goToHome() {
            const currentScreen = document.querySelector('.screen:not(.hidden)').id;
            resetPlayerState();
            showScreen(currentScreen, 'homeScreen');
        }

        function goToGenre() {
            const currentScreen = document.querySelector('.screen:not(.hidden)').id;
            resetPlayerState();
            showScreen(currentScreen, 'genreScreen');
        }

        function goToStory() {
            const currentScreen = document.querySelector('.screen:not(.hidden)').id;
            resetPlayerState();
            showScreen(currentScreen, 'storyScreen');
        }

        function showGenre(genre) {
            currentGenre = genre;
            const data = genreData[genre];
            
            document.getElementById('genreTitle').textContent = data.title;
            
            const grid = document.getElementById('storiesGrid');
            grid.innerHTML = '';
            
            Object.keys(data.stories).forEach(storyId => {
                const story = data.stories[storyId];
                const card = document.createElement('div');
                card.className = 'card story-card';
                card.onclick = () => showStory(storyId);
                card.innerHTML = `
                    <h3>${story.title}</h3>
                    <p>${story.description}</p>
                    <div class="creator">${story.creator}</div>
                `;
                grid.appendChild(card);
            });
            
            showScreen('homeScreen', 'genreScreen');
        }

        function showStory(storyId) {
            currentStory = storyId;
            const story = genreData[currentGenre].stories[storyId];
            
            document.getElementById('storyTitle').textContent = story.title;
            document.getElementById('storyCreator').textContent = story.creator;
            
            const grid = document.getElementById('episodesGrid');
            grid.innerHTML = '';
            
            Object.keys(story.episodes).forEach(episodeId => {
                const episode = story.episodes[episodeId];
                const card = document.createElement('div');
                card.className = 'card episode-card';
                card.onclick = () => showPlayer(episodeId);
                card.innerHTML = `
                    <h3>${episode.title}</h3>
                    <div class="description">${episode.description}</div>
                `;
                grid.appendChild(card);
            });
            
            showScreen('genreScreen', 'storyScreen');
        }

        function showPlayer(episodeId) {
            currentEpisode = episodeId;
            const episode = genreData[currentGenre].stories[currentStory].episodes[episodeId];
            
            document.getElementById('episodeTitle').textContent = episode.title;
            
            // Reset story progress
            storyProgress = { completed: [], currentPath: [] };
            
            showScreen('storyScreen', 'playerScreen');
            
            // Load the first segment and initialize map
            loadSegment('1A_opening');
        }

		function buildStoryMap() {
			const mapContent = document.getElementById('storyMapContent');
			mapContent.innerHTML = '';
			
			// Show completed path
			storyProgress.currentPath.forEach((nodeId, index) => {
				const node = storyTree[nodeId];
				const nodeElement = document.createElement('div');
				nodeElement.className = 'story-node completed';
				nodeElement.textContent = node.title;
				
				if (index > 0) {
					nodeElement.classList.add(`node-indent-${index}`);
				}
				
				mapContent.appendChild(nodeElement);
			});
			
			// Show current segment
			if (currentSegmentId && storyTree[currentSegmentId]) {
				const node = storyTree[currentSegmentId];
				const nodeElement = document.createElement('div');
				nodeElement.className = 'story-node current';
				nodeElement.textContent = node.title;
				
				if (storyProgress.currentPath.length > 0) {
					nodeElement.classList.add(`node-indent-${storyProgress.currentPath.length}`);
				}
				
				mapContent.appendChild(nodeElement);
			}
		}

		function loadSegment(segmentId) {
		   const segment = storySegments[segmentId];
		   if (!segment) {
			   console.error('Segment not found:', segmentId);
			   return;
		   }
		   // Stop current audio if playing
		   stopAudio();
		   // Clear previous choices
		   document.getElementById('choicesContainer').innerHTML = '';
		   
		   // Update title
		   document.getElementById('episodeTitle').textContent = segment.title;
		   document.getElementById('storyText').textContent = "Loading audio...";
		   // Load new audio
		   currentAudio = new Audio(segment.audio);
		   currentAudio.addEventListener('loadedmetadata', () => {
			   document.getElementById('totalTime').textContent = formatTime(currentAudio.duration);
			   document.getElementById('storyText').textContent = "Ready to play. Press play to continue...";
		   });
		   currentAudio.addEventListener('play', () => {
			   isPlaying = true;
			   document.getElementById('playPauseBtn').textContent = '⏸️';
			   document.getElementById('storyText').textContent = "Listen to the story and make your choices when they appear...";
		   });
		   currentAudio.addEventListener('pause', () => {
			   isPlaying = false;
			   document.getElementById('playPauseBtn').textContent = '▶️';
			   document.getElementById('storyText').textContent = "Audio paused. Press play to continue...";
		   });
		   currentAudio.addEventListener('timeupdate', () => {
			   updateProgress();
			   checkForChoices(segment);
		   });
		   currentAudio.addEventListener('ended', () => {
			   isPlaying = false;
			   document.getElementById('playPauseBtn').textContent = '▶️';
			   if (!segment.choices) {
				   document.getElementById('storyText').textContent = "End of this path. Choose restart to try again.";
			   }
		   });
		   currentAudio.addEventListener('error', (e) => {
			   console.error('Audio loading error:', e);
			   document.getElementById('storyText').textContent = "Error loading audio. Please check the file path.";
		   });
		   // Set current segment and update story map
		   currentSegmentId = segmentId;
		   buildStoryMap();
		}

        function updateProgress() {
            if (currentAudio) {
                const percent = (currentAudio.currentTime / currentAudio.duration) * 100;
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('currentTime').textContent = formatTime(currentAudio.currentTime);
            }
        }

        function checkForChoices(segment) {
            if (segment.choices && currentAudio) {
                const percentComplete = (currentAudio.currentTime / currentAudio.duration) * 100;
                if (percentComplete >= segment.choiceTime && document.getElementById('choicesContainer').children.length === 0) {
                    showChoices(segment.choices);
                }
            }
        }

		function showChoices(choices) {
			const container = document.getElementById('choicesContainer');
			container.innerHTML = '';
			
			choices.forEach((choice, index) => {
				const button = document.createElement('button');
				button.className = 'choice-btn';
				button.textContent = choice.text;
				button.onclick = () => makeChoice(choice.next);
				
				container.appendChild(button);
				
				setTimeout(() => {
					button.classList.add('show');
				}, index * 300);
			});
			
			// Show available choices in story map
			const mapContent = document.getElementById('storyMapContent');
			choices.forEach(choice => {
				const node = storyTree[choice.next];
				if (node) {
					const nodeElement = document.createElement('div');
					nodeElement.className = 'story-node available';
					nodeElement.textContent = node.title;
					nodeElement.classList.add(`node-indent-${storyProgress.currentPath.length + 1}`);
					mapContent.appendChild(nodeElement);
				}
			});
		}

		function makeChoice(nextSegmentId) {
			// Add current segment to completed path
			if (currentSegmentId && !storyProgress.currentPath.includes(currentSegmentId)) {
				storyProgress.currentPath.push(currentSegmentId);
			}
			loadSegment(nextSegmentId);
		}

        function togglePlay() {
            if (!currentAudio) return;
            
            if (isPlaying) {
                currentAudio.pause();
                document.getElementById('playPauseBtn').textContent = '▶️';
            } else {
                currentAudio.play();
                document.getElementById('playPauseBtn').textContent = '⏸️';
            }
            isPlaying = !isPlaying;
        }

        function rewind() {
            if (currentAudio) {
                currentAudio.currentTime = Math.max(0, currentAudio.currentTime - 10);
            }
        }

        function restart() {
            loadSegment('1A_opening');
        }

        function toggleStoryMap() {
            const panel = document.getElementById('storyMapPanel');
            const button = document.querySelector('.map-toggle');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                button.textContent = 'Hide';
            } else {
                panel.classList.add('collapsed');
                button.textContent = 'Show';
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
